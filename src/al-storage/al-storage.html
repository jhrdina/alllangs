<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-ts/polymer-ts.html">

<dom-module id="al-storage">
  <script src="../../bower_components/freezer-js/build/freezer.js"></script>
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
      auto
      url="/data.json"
      handle-as="json"
      on-last-response-changed="_onNewData">
    </iron-ajax>
    <app-indexeddb-mirror
      key="model"
      data="{{liveModel}}"
      on-persisted-data-changed="_onNewData">
    </app-indexeddb-mirror>

  </template>
  <script>
    Polymer({
      is: 'al-storage',

      properties: {
        model: {
          type: Object,
          notify: true
        },
      },

      ready: function() {
        this.freezer = new Freezer({
          page: 'main'
        });
        this.freezer.on('update', (m) => {
          //console.log("update");
          this.model = m;
        });
        this.model = this.freezer.get();
      },

      _onNewData: function(e) {
        this._updateModel(e.detail.value);
      },

      _updateModel: function(o) {
        this.model.set(Object.assign({}, o, {
          sections: o.sections.map((section, index) => Object.assign({}, section, {
            constructs: section.constructs.map((construct) => Object.assign({}, construct, {
              solutions: o.languages.map((lang) => ({
                text: construct.solutions[lang.id] || "",
                language: lang.id,
                prism: lang.prism,
                editing: false
              }))
            }))
          })),
          languages: o.languages.map((language) => Object.assign({}, language, {
            visible: true
          }))
        }));
      },

      parseJSON: function(json) {
        this._updateModel(JSON.parse(json));
      },

      exportJSON: function() {
        const solutionsToObject = function(solutions) {
          const obj = {};
          for (let i = 0; i < solutions.length; ++i) {
            obj[solutions[i].language] = solutions[i].text
          }
          return obj;
        }

        // TODO: Make me more restrictive
        const ex = Object.assign({}, this.model, {
          sections: this.model.sections.map((section) => Object.assign({}, section, {
            constructs: section.constructs.map((construct) => Object.assign({}, construct, {
              solutions: solutionsToObject(construct.solutions)
            }))
          }))
        });

        return JSON.stringify(ex, null, 2);
      },

      // ACTIONS

      solutionTap: function(detail) {
        this.model
          .sections[detail.sectionIndex]
          .constructs[detail.constructIndex]
          .solutions.find((solution) => solution.language === detail.language)
          .set({editing: true});
      },

      solutionKeydown: function(detail) {
        if (!(detail.keydownEvent.ctrlKey && detail.keydownEvent.keyCode === 13)) {
          return;
        }

        this.model
          .sections[detail.sectionIndex]
          .constructs[detail.constructIndex]
          .solutions.find((solution) => solution.language === detail.language)
          .set({editing: false});
      },

      solutionChanged: function(detail) {
        this.model
          .sections[detail.sectionIndex]
          .constructs[detail.constructIndex]
          .solutions.find((solution) => solution.language === detail.language)
          .set({text: detail.value});
      },

      openFilterSettings: function() {
        this.model
          .set('page', 'filter');
      },

      closeFilterSettings: function() {
        this.model
          .set('page', 'main');
      },

      routePageChanged: function(detail) {
        this.model
          .set('page', detail.page || 'main');
      },

      changeLanguageVisibility: function(detail) {
        this.model
          .languages.find((language) => language.id === detail.language)
          .set({ visible: detail.visible });
      }
    });
  </script>
</dom-module>
