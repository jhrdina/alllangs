
<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">

<!-- Iron elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../my-icons.html">

<!-- App Shell -->
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">

<!-- Paper elements -->
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/paper-styles/default-theme.html">

<link rel="import" href="../al-main-view/al-main-view.html">
<link rel="import" href="../al-storage/al-storage.html">

<dom-module id="al-app">
  <template>
    <style>
      /* Presunout z rootu do hostu */
      :root {
        --dark-primary-color:       #5D4037;
        --primary-color:            #795548;
        --accent-color:             #FF9800;
      }

      :host {
        @apply(--layout-fullbleed);
        display: block;
        @apply(--layout-vertical);

        color: var(--primary-text-color);
        line-height: initial;
      }

      paper-toolbar#mainToolbar .title {
        margin: 0;
        overflow: visible;
      }

      .dropdown-content {
        background-color: #fff;
        color: #111111;
      }

      #mainMenu {
        width: 11em;
      }

      .menu-separator {
        border-top: 1px solid #ddd;
      }

      #file {
        display: none;
      }

      paper-scroll-header-panel {
        @apply(--layout-flex);
        background: #ECECEC;
        /*overflow-x: auto;*/

        --paper-scroll-header-container: {
          overflow-x: auto;
        };
      }
    </style>

    <!-- <app-location route="{{route}}"></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route> -->
    <!--  -->
    <al-storage id="storage" model="{{model}}"></al-storage>

    <!-- Main content -->
    <paper-scroll-header-panel main id="headerPanelMain">

      <!-- Main Toolbar -->
      <paper-toolbar id="mainToolbar">
        <div class="title">All Languages</div>
        <paper-icon-button icon="search"></paper-icon-button>
        <paper-menu-button horizontal-align="right">
          <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
          <div class="dropdown-content" id="mainMenu">
            <paper-item on-tap="chooseLanguagesTapped">Choose languages</paper-item>
            <paper-item on-tap="addLanguageTapped">Add language</paper-item>
            <div class="menu-separator"></div>
            <paper-item on-tap="importTapped">Import</paper-item>
            <input type="file" id="file" on-change="_onFileSelected"/>
            <paper-item on-tap="exportTapped">Export</paper-item>
            <div class="menu-separator"></div>
            <paper-item on-tap="shortcutsTapped">Key shortcuts</paper-item>
          </div>
        </paper-menu-button>
      </paper-toolbar>

      <!-- Main Content -->
      <al-main-view
        class="content"
        languages="[[model.languages]]"
        sections="[[model.sections]]"
        on-solution-tap="_dispatch"
        on-solution-keydown="_dispatch"
        on-solution-changed="_dispatch"
        ></al-main-view>
    </paper-scroll-header-panel>
  </template>

  <script>
    Polymer({
      is: 'al-app',

      properties: {
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
      },

      observers: [
        '_routePageChanged(routeData.page)'
      ],

      _dispatch: function(event) {
        this.$.storage[this._camelCase(event.type)](event.detail);
      },

      _camelCase: function(input) {
          return input.toLowerCase().replace(/-(.)/g, function(match, group1) {
              return group1.toUpperCase();
          });
      },

      _onFileSelected: function(e) {
        var file = e.target.files[0];
        if (!file) {
          return;
        }

        var reader = new FileReader();
        reader.addEventListener('load', e => {
          this.$.storage.parseJSON(e.target.result);
        });

        reader.readAsText(file);
      },

      exportTapped: function() {
        const data = this.$.storage.exportJSON()
        this.download('data.json', data);
      },

      download: function(filename, data) {
        var element = document.createElement('a');
        element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(data));
        element.setAttribute('download', filename);

        element.style.display = 'none';

        // TODO: Append to local DOM
        document.body.appendChild(element);

        element.click();

        document.body.removeChild(element);
      },

      importTapped: function() {
        this.$.file.click();
      },

      // Default routing stuff

      // _routePageChanged: function(page) {
      //   this.page = page || 'view1';
      // },

      // _pageChanged: function(page) {
      //   // Load page import on demand. Show 404 page if fails
      //   var resolvedPageUrl = this.resolveUrl(`../my-${page}/my-${page}.html`);
      //   this.importHref(resolvedPageUrl, null, this._showPage404, true);
      // },

      // _showPage404: function() {
      //   this.page = 'view404';
      // },
    });
  </script>
</dom-module>
